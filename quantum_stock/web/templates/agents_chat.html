{% extends "base.html" %}

{% block title %}AI Agents Team - Quantum Stock{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold">
                <i class="fas fa-users mr-2 text-accent-cyan"></i>AI Agents Team Discussion
            </h1>
            <p class="text-gray-400 mt-1">ƒê·ªôi ng≈© AI c·ªë v·∫•n v·ªõi nhi·ªÅu g√≥c nh√¨n kh√°c nhau</p>
        </div>
        <div class="flex items-center space-x-4">
            <span class="flex items-center text-sm">
                <span class="w-2 h-2 bg-accent-green rounded-full status-online mr-2"></span>
                5 Agents Online
            </span>
        </div>
    </div>

    <div class="grid grid-cols-4 gap-6">
        <!-- Agent Cards -->
        <div class="space-y-4">
            <div class="glass rounded-xl p-4 border-l-4 border-accent-cyan">
                <div class="flex items-center space-x-3">
                    <span class="text-3xl">üìä</span>
                    <div>
                        <h3 class="font-semibold text-accent-cyan">Alex Analyst</h3>
                        <p class="text-xs text-gray-400">Technical Analysis</p>
                    </div>
                </div>
                <p class="text-sm text-gray-300 mt-2">Ph√¢n t√≠ch k·ªπ thu·∫≠t thu·∫ßn t√∫y, d·ª±a tr√™n d·ªØ li·ªáu v√† ch·ªâ b√°o</p>
                <div class="mt-2 text-xs">
                    <span class="px-2 py-1 bg-dark-600 rounded">RSI, MACD, EMA</span>
                </div>
            </div>

            <div class="glass rounded-xl p-4 border-l-4 border-accent-green">
                <div class="flex items-center space-x-3">
                    <span class="text-3xl">üêÇ</span>
                    <div>
                        <h3 class="font-semibold text-accent-green">Bull Advisor</h3>
                        <p class="text-xs text-gray-400">Bullish Perspective</p>
                    </div>
                </div>
                <p class="text-sm text-gray-300 mt-2">T√¨m ki·∫øm c∆° h·ªôi tƒÉng gi√°, momentum t√≠ch c·ª±c</p>
                <div class="mt-2 text-xs">
                    <span class="px-2 py-1 bg-dark-600 rounded">Opportunities</span>
                </div>
            </div>

            <div class="glass rounded-xl p-4 border-l-4 border-accent-red">
                <div class="flex items-center space-x-3">
                    <span class="text-3xl">üêª</span>
                    <div>
                        <h3 class="font-semibold text-accent-red">Bear Advisor</h3>
                        <p class="text-xs text-gray-400">Bearish Perspective</p>
                    </div>
                </div>
                <p class="text-sm text-gray-300 mt-2">C·∫£nh b√°o r·ªßi ro, t√¨m t√≠n hi·ªáu bearish</p>
                <div class="mt-2 text-xs">
                    <span class="px-2 py-1 bg-dark-600 rounded">Risk Warnings</span>
                </div>
            </div>

            <div class="glass rounded-xl p-4 border-l-4 border-accent-purple">
                <div class="flex items-center space-x-3">
                    <span class="text-3xl">üè•</span>
                    <div>
                        <h3 class="font-semibold text-accent-purple">Risk Doctor</h3>
                        <p class="text-xs text-gray-400">Risk Management</p>
                    </div>
                </div>
                <p class="text-sm text-gray-300 mt-2">Qu·∫£n l√Ω r·ªßi ro, t√≠nh to√°n size v·ªã th·∫ø</p>
                <div class="mt-2 text-xs">
                    <span class="px-2 py-1 bg-dark-600 rounded">Kelly, VaR</span>
                </div>
            </div>

            <div class="glass rounded-xl p-4 border-l-4 border-yellow-400">
                <div class="flex items-center space-x-3">
                    <span class="text-3xl">üéñ</span>
                    <div>
                        <h3 class="font-semibold text-yellow-400">Chief</h3>
                        <p class="text-xs text-gray-400">Final Decision</p>
                    </div>
                </div>
                <p class="text-sm text-gray-300 mt-2">T·ªïng h·ª£p v√† ƒë∆∞a ra quy·∫øt ƒë·ªãnh cu·ªëi c√πng</p>
                <div class="mt-2 text-xs">
                    <span class="px-2 py-1 bg-dark-600 rounded">Verdict</span>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="col-span-3 glass rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold">Team Discussion</h2>
                <div class="flex space-x-2">
                    <input type="text" id="agentSymbol" value="FPT" placeholder="M√£ CP"
                           class="w-24 bg-dark-700 border border-dark-500 rounded-lg px-3 py-1 text-sm focus:outline-none focus:border-accent-cyan">
                    <button onclick="startDiscussion()" class="px-4 py-1 bg-accent-cyan text-dark-900 rounded-lg text-sm font-semibold hover:bg-accent-cyan/80">
                        <i class="fas fa-comments mr-1"></i>Th·∫£o Lu·∫≠n
                    </button>
                </div>
            </div>

            <div id="agentChat" class="h-[600px] overflow-y-auto space-y-4 p-4 bg-dark-800 rounded-lg">
                <div class="text-center text-gray-500 py-16">
                    <i class="fas fa-robot text-6xl mb-4"></i>
                    <p class="text-lg">Nh·∫≠p m√£ c·ªï phi·∫øu ƒë·ªÉ b·∫Øt ƒë·∫ßu th·∫£o lu·∫≠n</p>
                    <p class="text-sm mt-2">ƒê·ªôi AI s·∫Ω ph√¢n t√≠ch t·ª´ nhi·ªÅu g√≥c nh√¨n kh√°c nhau</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
async function startDiscussion() {
    const symbol = document.getElementById('agentSymbol').value.toUpperCase() || 'FPT';
    const chatDiv = document.getElementById('agentChat');

    chatDiv.innerHTML = `
        <div class="text-center py-16">
            <i class="fas fa-spinner fa-spin text-4xl text-accent-cyan mb-4"></i>
            <p>Team ƒëang ph√¢n t√≠ch ${symbol}...</p>
        </div>
    `;

    try {
        const response = await fetch('/api/agents/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ symbol })
        });

        const data = await response.json();
        if (data.success) {
            displayDiscussion(data.discussion, symbol);
        }
    } catch (error) {
        chatDiv.innerHTML = `<div class="text-center text-accent-red py-8">L·ªói: ${error.message}</div>`;
    }
}

function displayDiscussion(discussion, symbol) {
    const chatDiv = document.getElementById('agentChat');
    const emojis = { 'Alex': 'üìä', 'Bull': 'üêÇ', 'Bear': 'üêª', 'Chief': 'üéñ', 'RiskDoctor': 'üè•' };
    const colors = { 'Alex': 'border-accent-cyan', 'Bull': 'border-accent-green', 'Bear': 'border-accent-red', 'Chief': 'border-yellow-400', 'RiskDoctor': 'border-accent-purple' };

    let html = `<div class="text-center mb-6"><span class="px-4 py-2 bg-dark-600 rounded-full">Ph√¢n t√≠ch ${symbol}</span></div>`;

    discussion.messages.forEach((msg, i) => {
        html += `
            <div class="chat-message glass rounded-lg p-4 border-l-4 ${colors[msg.agent_name] || 'border-gray-500'}" style="animation-delay: ${i*0.1}s">
                <div class="flex items-start space-x-3">
                    <span class="text-2xl">${msg.agent_emoji || emojis[msg.agent_name]}</span>
                    <div class="flex-1">
                        <span class="font-semibold">${msg.agent_name}</span>
                        ${msg.confidence ? `<span class="text-xs ml-2 px-2 py-1 bg-dark-600 rounded">${msg.confidence.toFixed(0)}%</span>` : ''}
                        <p class="text-gray-300 mt-1">${msg.content}</p>
                    </div>
                </div>
            </div>
        `;
    });

    if (discussion.final_verdict) {
        const v = discussion.final_verdict;
        html += `
            <div class="glass rounded-lg p-6 border-2 border-accent-cyan mt-6">
                <h3 class="text-xl font-bold mb-4">üéñ FINAL VERDICT: ${v.signal_type}</h3>
                <div class="grid grid-cols-4 gap-4">
                    <div><span class="text-gray-400">Confidence</span><p class="text-lg font-bold">${v.confidence?.toFixed(1)}%</p></div>
                    <div><span class="text-gray-400">Stop Loss</span><p class="text-lg font-bold text-accent-red">${v.stop_loss?.toFixed(2) || '--'}</p></div>
                    <div><span class="text-gray-400">Take Profit</span><p class="text-lg font-bold text-accent-green">${v.take_profit?.toFixed(2) || '--'}</p></div>
                    <div><span class="text-gray-400">R:R</span><p class="text-lg font-bold">1:${v.risk_reward_ratio?.toFixed(1) || '--'}</p></div>
                </div>
            </div>
        `;
    }

    chatDiv.innerHTML = html;
}
</script>
{% endblock %}
